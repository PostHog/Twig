#!/bin/bash

# Setup script for Array development environment
# Run this after cloning or when changing AGENT_PACKAGE_LOCATION in .env

echo "ðŸ”§ Setting up Array development environment..."

# Load .env file if it exists
if [ -f .env ]; then
  export $(grep -v '^#' .env | grep -v '^[[:space:]]*$' | xargs)
fi

# Start with base workspace config
cp pnpm-workspace.base.yaml pnpm-workspace.yaml

# If AGENT_PACKAGE_LOCATION is set, add the override and build the agent
if [ -n "$AGENT_PACKAGE_LOCATION" ]; then
  echo "âœ“ Using local @posthog/agent from: $AGENT_PACKAGE_LOCATION"
  cat >> pnpm-workspace.yaml <<EOF

overrides:
  "@posthog/agent": $AGENT_PACKAGE_LOCATION
EOF

  # Extract the path from file:../agent format
  AGENT_PATH="${AGENT_PACKAGE_LOCATION#file:}"

  if [ -d "$AGENT_PATH" ]; then
    echo "ðŸ“¦ Building @posthog/agent..."
    (cd "$AGENT_PATH" && pnpm install && pnpm build)
    echo "âœ“ @posthog/agent built successfully"
  else
    echo "âš ï¸  Warning: Agent path $AGENT_PATH does not exist"
  fi
else
  echo "âœ“ Using production @posthog/agent package"
fi

echo "âœ“ Workspace configured"
